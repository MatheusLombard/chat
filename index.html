<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agente de IA ‚Äî L√≥gica Proposicional</title>

  <!-- Fonte Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Poppins', 'sans-serif'] },
          colors: {
            brand: {
              500: '#3B82F6'
            },
            blackpure: '#000000',
            graphite: '#111111',
          }
        }
      }
    }
  </script>

  <style>
    html, body { height: 100%; }
    body { font-family: 'Poppins', sans-serif; -webkit-font-smoothing: antialiased; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 999px; }
  </style>
</head>

<body class="bg-gray-50 dark:bg-blackpure text-gray-800 dark:text-gray-100 min-h-full transition-colors duration-300">

  <!-- Top Bar -->
  <header class="w-full py-4 px-6 flex items-center justify-between border-b border-gray-200 dark:border-gray-800 bg-white/60 dark:bg-graphite/80 backdrop-blur-xl sticky top-0 z-10">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-gray-900 to-gray-700 rounded-xl flex items-center justify-center text-white text-lg font-semibold shadow-inner">AI</div>
      <div>
        <h1 class="text-lg font-semibold">Agente de IA ‚Äî L√≥gica Proposicional</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400"> </p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <button id="clearHistoryBtn" title="Limpar hist√≥rico"
        class="hidden md:inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 hover:opacity-80 transition">
        üßπ Limpar hist√≥rico
      </button>

      <button id="toggleTheme" title="Alternar tema"
        class="p-2 rounded-lg bg-gray-100 dark:bg-gray-900 shadow-md hover:scale-105 transition">
        üåô
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="flex gap-6 p-6 max-w-7xl mx-auto">
    
    <!-- Sidebar Hist√≥rico -->
    <aside class="w-80 hidden lg:block">
      <div class="sticky top-6 bg-white dark:bg-graphite rounded-2xl shadow-lg p-4 h-[80vh] overflow-auto border border-gray-100 dark:border-gray-800">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-semibold">üìú Hist√≥rico</h2>
          <span id="histCount" class="text-xs text-gray-500 dark:text-gray-400">0</span>
        </div>
        <div id="historyList" class="flex flex-col gap-3"></div>
        <div class="mt-6 text-xs text-gray-500 dark:text-gray-500">
          Hist√≥rico salvo localmente (localStorage). Clique para restaurar.
        </div>
      </div>
    </aside>

    <!-- Main Card -->
    <section class="flex-1">
      <div class="bg-white dark:bg-graphite rounded-3xl shadow-2xl p-6 border border-gray-100 dark:border-gray-800 transition">
        
        <!-- Modo -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="flex items-center bg-gray-100 dark:bg-black rounded-xl p-2 gap-2 shadow-inner">
              <button id="modeNlToCpc" class="mode-btn active px-4 py-2 rounded-lg text-sm font-medium bg-gray-900 text-white">NL ‚Üí CPC</button>
              <button id="modeCpcToNl" class="mode-btn px-4 py-2 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200">CPC ‚Üí NL</button>
            </div>
          </div>

          <div class="flex-1">
            <div class="flex items-center justify-between">
              <label class="text-sm text-gray-500 dark:text-gray-400">Proposi√ß√µes (m√≠nimo 1)</label>
              <span class="text-xs text-gray-400">Informe 1 a 3 mapeamentos (Letra = descri√ß√£o)</span>
            </div>
            <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2">
              <input class="prop-input px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent text-sm focus:outline-none focus:ring-2 focus:ring-gray-600" placeholder="X = descri√ß√£o" />
              <input class="prop-input px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent text-sm focus:outline-none focus:ring-2 focus:ring-gray-600" placeholder="Y = descri√ß√£o" />
              <input class="prop-input px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-transparent text-sm focus:outline-none focus:ring-2 focus:ring-gray-600" placeholder="Z = descri√ß√£o" />
            </div>
          </div>
        </div>

        <!-- Entrada -->
        <div class="mt-6">
          <textarea id="entrada" rows="4" placeholder="Digite uma frase ou f√≥rmula l√≥gica..."
            class="w-full p-4 rounded-2xl border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-black text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-gray-600 resize-none"></textarea>
        </div>

        <!-- Bot√µes -->
        <div class="mt-4 flex items-center gap-3">
          <button id="traduzirBtn" class="bg-gray-900 hover:bg-black text-white px-5 py-2 rounded-xl shadow-lg transition">‚ñ∂Ô∏è Traduzir</button>
          <button id="copyBtn" class="px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-black text-sm">üìã Copiar resultado</button>
          <button id="useSampleBtn" class="px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-black text-sm">‚ú® Exemplo</button>
          <div id="status" class="ml-auto text-sm text-gray-500 dark:text-gray-400">Pronto</div>
        </div>

        <!-- Resultado -->
        <div id="resultadoCard" class="mt-6 p-4 rounded-2xl bg-gray-50 dark:bg-black border border-gray-100 dark:border-gray-800 min-h-[120px]">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-lg bg-gray-900 flex items-center justify-center text-white font-semibold">‚Üí</div>
            <div class="flex-1">
              <div class="text-xs text-gray-400 dark:text-gray-500">Resultado</div>
              <div id="resultado" class="mt-2 text-lg font-medium break-words text-gray-900 dark:text-white">üîç O resultado aparecer√° aqui...</div>
              <div id="meta" class="mt-3 text-sm text-gray-500 dark:text-gray-400"></div>
            </div>
          </div>
        </div>

      </div>

      <!-- Hist√≥rico Mobile -->
      <div class="lg:hidden mt-6">
        <div class="bg-white dark:bg-graphite rounded-2xl p-4 shadow border border-gray-100 dark:border-gray-800">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold">üìú Hist√≥rico</h3>
            <span id="histCountMobile" class="text-xs text-gray-400">0</span>
          </div>
          <div id="historyListMobile" class="mt-3 flex gap-2 overflow-x-auto"></div>
        </div>
      </div>

    </section>
  </main>

  <!-- Script -->
  <script>
    const API_URL = "http://engenheirodesoftware.shop/api/chat";
    const HISTORY_KEY = "agente_logico_history_v2";
    const docEl = document.documentElement;

    const toggleThemeBtn = document.getElementById("toggleTheme");
    const entrada = document.getElementById("entrada");
    const traduzirBtn = document.getElementById("traduzirBtn");
    const resultadoEl = document.getElementById("resultado");
    const metaEl = document.getElementById("meta");
    const statusEl = document.getElementById("status");
    const modeNlToCpc = document.getElementById("modeNlToCpc");
    const modeCpcToNl = document.getElementById("modeCpcToNl");
    const propInputs = Array.from(document.querySelectorAll('.prop-input'));
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");
    const historyList = document.getElementById("historyList");
    const historyListMobile = document.getElementById("historyListMobile");
    const histCount = document.getElementById("histCount");
    const histCountMobile = document.getElementById("histCountMobile");
    const copyBtn = document.getElementById("copyBtn");
    const useSampleBtn = document.getElementById("useSampleBtn");

    // Tema
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") docEl.classList.add("dark");
    toggleThemeBtn.textContent = docEl.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    toggleThemeBtn.onclick = () => {
      docEl.classList.toggle("dark");
      const mode = docEl.classList.contains("dark") ? "dark" : "light";
      localStorage.setItem("theme", mode);
      toggleThemeBtn.textContent = mode === "dark" ? "‚òÄÔ∏è" : "üåô";
    };

    // Modo NL ‚Üî CPC
    let currentMode = "nl_para_cpc";
    modeNlToCpc.onclick = () => setMode("nl_para_cpc");
    modeCpcToNl.onclick = () => setMode("cpc_para_nl");
    function setMode(mode) {
      currentMode = mode;
      [modeNlToCpc, modeCpcToNl].forEach(btn => btn.classList.remove("bg-gray-900","text-white"));
      if (mode === "nl_para_cpc") modeNlToCpc.classList.add("bg-gray-900","text-white");
      else modeCpcToNl.classList.add("bg-gray-900","text-white");
    }

    // Hist√≥rico
    function loadHistory() {
      try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); } catch { return []; }
    }
    function saveHistory(h) { localStorage.setItem(HISTORY_KEY, JSON.stringify(h)); renderHistory(); }
    function pushHistory(item) {
      const hist = loadHistory();
      hist.unshift(item);
      saveHistory(hist.slice(0,10));
    }
    function renderHistory() {
      const hist = loadHistory();
      histCount.textContent = hist.length;
      histCountMobile.textContent = hist.length;
      historyList.innerHTML = hist.length ? "" : `<div class='text-sm text-gray-500 dark:text-gray-400'>Nenhuma consulta.</div>`;
      historyListMobile.innerHTML = "";
      hist.forEach(item => {
        const el = document.createElement("div");
        el.className = "p-3 rounded-xl border dark:border-gray-700 bg-gray-50 dark:bg-black hover:opacity-80 transition cursor-pointer";
        el.innerHTML = `<div class='text-xs text-gray-500 dark:text-gray-400 mb-1'>${new Date(item.ts).toLocaleString()}</div>
                        <div class='text-sm font-medium mb-1'>${item.input}</div>
                        <div class='text-xs text-gray-500 dark:text-gray-400'>‚Üí ${item.output}</div>`;
        el.onclick = () => { entrada.value = item.input; resultadoEl.textContent = item.output; metaEl.textContent = `${item.mode === "nl_para_cpc" ? "NL ‚Üí CPC" : "CPC ‚Üí NL"}`; };
        historyList.appendChild(el);

        const token = document.createElement("div");
        token.className = "px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-black text-xs whitespace-nowrap cursor-pointer";
        token.textContent = item.input.slice(0,25);
        token.onclick = () => { entrada.value = item.input; resultadoEl.textContent = item.output; };
        historyListMobile.appendChild(token);
      });
    }
    renderHistory();
    clearHistoryBtn.onclick = () => { localStorage.removeItem(HISTORY_KEY); renderHistory(); };

    function normalizeMappingEntry(entry) {
      if (!entry) return null;
      const cleaned = entry.replace(/,/g,'=').replace(/:/g,'=').trim();
      if (!cleaned) return null;
      const [symbolRaw, ...rest] = cleaned.split('=');
      if (!rest.length) return cleaned;
      const letter = (symbolRaw.trim().match(/[A-Za-z]/) || [''])[0].toUpperCase();
      const desc = rest.join('=').trim();
      if (!letter || !desc) return null;
      return `${letter} = ${desc}`;
    }

    function buildDefinitions() {
      const entries = propInputs
        .map(input => normalizeMappingEntry(input.value))
        .filter(Boolean);
      if (!entries.length) {
        throw new Error('Informe pelo menos uma proposi√ß√£o (campo obrigat√≥rio).');
      }
      return entries.join('; ');
    }

    function buildQuestionPayload() {
      const text = entrada.value.trim();
      if (!text) throw new Error('Digite algo primeiro.');
      const defs = buildDefinitions();
      if (currentMode === 'nl_para_cpc') {
        const prompt = `Transforme para o CPC: ${text}`;
        return `${defs}; ${prompt}`;
      }
      const prompt = `transforme para linguagem natural: ${text}`;
      return `${defs}; ${prompt}`;
    }

    async function callBackend(question) {
      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question })
      });
      if (!resp.ok) {
        const msg = await resp.text();
        throw new Error(msg || 'Erro ao consultar backend');
      }
      return resp.json();
    }

    async function traduzir() {
      let payload;
      try {
        payload = buildQuestionPayload();
      } catch (err) {
        return alert(err.message);
      }
      statusEl.textContent = 'Consultando backend...';
      traduzirBtn.disabled = true;
      traduzirBtn.textContent = 'Processando...';
      try {
        const data = await callBackend(payload);
        const resposta = data?.response || 'Sem resposta.';
        resultadoEl.textContent = resposta;
        metaEl.textContent = currentMode === 'nl_para_cpc' ? 'NL ‚Üí CPC' : 'CPC ‚Üí NL';
        pushHistory({ input: payload, output: resposta, mode: currentMode, ts: Date.now() });
        statusEl.textContent = 'Pronto';
      } catch (error) {
        console.error(error);
        resultadoEl.textContent = 'Erro ao obter resposta.';
        metaEl.textContent = error.message;
        statusEl.textContent = 'Erro';
      } finally {
        traduzirBtn.disabled = false;
        traduzirBtn.textContent = '‚ñ∂Ô∏è Traduzir';
      }
    }

    traduzirBtn.onclick = () => traduzir();

    copyBtn.onclick = async () => {
      await navigator.clipboard.writeText(resultadoEl.textContent);
      copyBtn.textContent = "‚úî Copiado";
      setTimeout(()=>copyBtn.textContent="üìã Copiar resultado",1500);
    };
    useSampleBtn.onclick = () => {
      if (currentMode === "nl_para_cpc") {
        entrada.value = "Se Rafael √© fil√≥sofo e Jo√£o √© m√©dico, ent√£o Lucas √© doutor.";
        propInputs[0].value = "X = Rafael √© fil√≥sofo";
        propInputs[1].value = "J = Jo√£o √© m√©dico";
        propInputs[2].value = "Y = Lucas √© doutor";
      } else {
        entrada.value = "(P^Q)->R";
        propInputs[0].value = "P = Jo√£o estuda";
        propInputs[1].value = "Q = Maria trabalha";
        propInputs[2].value = "R = Pedro passa";
      }
    };
  </script>
</body>
</html>







